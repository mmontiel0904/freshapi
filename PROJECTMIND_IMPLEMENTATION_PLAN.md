# ProjectMind Implementation Plan

## 🧠 Feature Overview
**ProjectMind** is an intelligent context database system that extends projects with structured data capture and organization. The initial implementation focuses on email context ingestion for accounting workflows, with an extensible architecture for future context types.

## 🎯 Goals
- Create a relational, high-performance context storage system
- Implement email ingestion via n8n workflows
- Build MCP-ready search and retrieval capabilities
- Design extensible architecture for future context types
- Maintain strong type safety and performance

## 📊 Database Architecture

### Core Tables Structure

```sql
-- Context Types Registry
context_types (
  id UUID PRIMARY KEY,
  name VARCHAR(50) NOT NULL UNIQUE,     -- 'email', 'document', 'meeting'
  description TEXT,
  schema_version INT DEFAULT 1,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Project-specific Categories (User Defined)
project_context_categories (
  id UUID PRIMARY KEY,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  context_type_id UUID NOT NULL REFERENCES context_types(id),
  name VARCHAR(100) NOT NULL,           -- "Invoices", "Purchase Orders", "Client Communications"
  color VARCHAR(7) DEFAULT '#6366f1',   -- Hex color for UI
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(project_id, context_type_id, name)
);

-- Base Context Records
project_contexts (
  id UUID PRIMARY KEY,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  context_type_id UUID NOT NULL REFERENCES context_types(id),
  category_id UUID REFERENCES project_context_categories(id) ON DELETE SET NULL,
  title VARCHAR(255) NOT NULL,          -- Auto-generated or manual
  description TEXT,
  tags TEXT[] DEFAULT '{}',             -- PostgreSQL array for flexible tagging
  metadata JSONB DEFAULT '{}',          -- Flexible metadata (minimal use)
  is_archived BOOLEAN DEFAULT FALSE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Accounting Process Enum
CREATE TYPE accounting_process_enum AS ENUM (
  'AP',          -- Accounts Payable
  'AR',          -- Accounts Receivable  
  'BR',          -- Bank Reconciliation
  'Reporting',   -- Financial Reporting
  'General',     -- General accounting
  'Tax',         -- Tax-related
  'Payroll',     -- Payroll processing
  'Audit'        -- Audit activities
);

-- Email Contexts (Specialized Table)
email_contexts (
  id UUID PRIMARY KEY REFERENCES project_contexts(id) ON DELETE CASCADE,
  
  -- Email Headers
  from_email VARCHAR(255) NOT NULL,
  from_name VARCHAR(255),
  to_emails VARCHAR(255)[] NOT NULL,    -- PostgreSQL array
  cc_emails VARCHAR(255)[] DEFAULT '{}',
  bcc_emails VARCHAR(255)[] DEFAULT '{}',
  reply_to VARCHAR(255),
  
  -- Content
  subject VARCHAR(500) NOT NULL,
  message_preview TEXT,                 -- First 500 chars for quick display
  full_message TEXT NOT NULL,
  message_html TEXT,                    -- Original HTML if available
  
  -- Business Context
  accounting_process accounting_process_enum NOT NULL,
  ai_summary TEXT,                      -- Generated by n8n workflow
  confidence_score DECIMAL(5,4),        -- 0.0000 to 1.0000 AI confidence
  extracted_entities JSONB DEFAULT '{}', -- Names, amounts, dates extracted by AI
  
  -- Email Metadata
  message_id VARCHAR(255),              -- Email Message-ID header
  thread_id VARCHAR(255),               -- For threading emails
  in_reply_to VARCHAR(255),             -- Reply chain tracking
  message_date TIMESTAMP,               -- Original email timestamp
  received_date TIMESTAMP DEFAULT NOW(), -- When we ingested it
  
  -- Attachments
  has_attachments BOOLEAN DEFAULT FALSE,
  attachment_count INT DEFAULT 0,
  
  -- Processing Status
  processing_status VARCHAR(20) DEFAULT 'completed', -- 'pending', 'completed', 'failed', 'manual_review'
  processing_notes TEXT,
  
  -- Constraints
  CONSTRAINT valid_confidence_score CHECK (confidence_score >= 0 AND confidence_score <= 1),
  CONSTRAINT valid_processing_status CHECK (processing_status IN ('pending', 'completed', 'failed', 'manual_review'))
);

-- Email Attachments (Future Extension)
email_attachments (
  id UUID PRIMARY KEY,
  email_context_id UUID NOT NULL REFERENCES email_contexts(id) ON DELETE CASCADE,
  filename VARCHAR(255) NOT NULL,
  original_filename VARCHAR(255) NOT NULL,
  file_size BIGINT,
  content_type VARCHAR(100),
  file_hash VARCHAR(64),                -- SHA-256 for deduplication
  storage_path TEXT NOT NULL,           -- File storage location/URL
  extracted_text TEXT,                  -- OCR/text extraction results
  is_processed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Performance Indexes
```sql
-- Core context indexes
CREATE INDEX idx_project_contexts_project_type ON project_contexts(project_id, context_type_id);
CREATE INDEX idx_project_contexts_category ON project_contexts(category_id) WHERE category_id IS NOT NULL;
CREATE INDEX idx_project_contexts_created_at ON project_contexts(created_at DESC);
CREATE INDEX idx_project_contexts_tags ON project_contexts USING gin(tags);
CREATE INDEX idx_project_contexts_archived ON project_contexts(is_archived, project_id);

-- Email context indexes for fast searching
CREATE INDEX idx_email_contexts_from ON email_contexts(from_email);
CREATE INDEX idx_email_contexts_process ON email_contexts(accounting_process);
CREATE INDEX idx_email_contexts_message_date ON email_contexts(message_date DESC) WHERE message_date IS NOT NULL;
CREATE INDEX idx_email_contexts_status ON email_contexts(processing_status);

-- Full-text search indexes
CREATE INDEX idx_email_contexts_subject_search ON email_contexts USING gin(to_tsvector('english', subject));
CREATE INDEX idx_email_contexts_message_search ON email_contexts USING gin(to_tsvector('english', full_message));
CREATE INDEX idx_email_contexts_combined_search ON email_contexts USING gin(to_tsvector('english', subject || ' ' || COALESCE(full_message, '')));

-- Category management
CREATE INDEX idx_context_categories_project_type ON project_context_categories(project_id, context_type_id);
CREATE INDEX idx_context_categories_active ON project_context_categories(is_active, project_id);
```

## 🚀 Implementation Steps

### Phase 1: Database Foundation (Day 1)

#### Step 1.1: Create Database Entities
- [ ] `src/entities/context_type.rs`
- [ ] `src/entities/project_context_category.rs`  
- [ ] `src/entities/project_context.rs`
- [ ] `src/entities/email_context.rs`
- [ ] `src/entities/email_attachment.rs`
- [ ] Update `src/entities/mod.rs` and `prelude.rs`

#### Step 1.2: Create Migration
- [ ] `migration/src/m20250119_000001_create_projectmind_system.rs`
- [ ] Seed initial context types (email, document, meeting)
- [ ] Create all tables with proper constraints and indexes
- [ ] Add RBAC permissions for context management

#### Step 1.3: Update Migration System
- [ ] Update `migration/src/lib.rs` to include new migration
- [ ] Test migration up/down functionality

### Phase 2: Core Services (Day 1-2)

#### Step 2.1: Context Service Layer
- [ ] `src/services/context.rs` - Core context management
  - Create/read/update/delete contexts
  - Category management
  - Search and filtering
  - Permission checks

#### Step 2.2: Email Context Service
- [ ] `src/services/email_context.rs` - Email-specific operations
  - Email ingestion and validation
  - Duplicate detection (by message_id)
  - Thread relationship building
  - AI summary processing

#### Step 2.3: Update Service Module
- [ ] Update `src/services/mod.rs` to export new services
- [ ] Integrate services into main.rs AppState

### Phase 3: GraphQL API (Day 2)

#### Step 3.1: GraphQL Types
- [ ] Add to `src/graphql/types.rs`:
  - `ContextType`
  - `ProjectContextCategory` 
  - `ProjectContext`
  - `EmailContext`
  - `AccountingProcess` enum
  - Input types for mutations

#### Step 3.2: GraphQL Queries
- [ ] Add to `src/graphql/query.rs`:
  - `project_contexts()` - List contexts with filtering
  - `email_contexts()` - Email-specific queries
  - `context_categories()` - List project categories
  - `search_email_contexts()` - Full-text search
  - `context_stats()` - Analytics queries

#### Step 3.3: GraphQL Mutations  
- [ ] Add to `src/graphql/mutation.rs`:
  - `create_context_category()`
  - `update_context_category()`
  - `delete_context_category()`
  - `ingest_email_context()` - For webhook
  - `update_email_context()`
  - `archive_context()`

#### Step 3.4: DataLoader Integration
- [ ] Update `src/graphql/dataloader.rs`:
  - Add context category loader
  - Add email context loader
  - Optimize N+1 queries

### Phase 4: Webhook & API Endpoints (Day 2-3)

#### Step 4.1: Email Ingestion Endpoint
- [ ] Create REST endpoint for n8n integration:
  - `POST /api/projects/{project_id}/contexts/email/ingest`
  - Authentication via JWT or API key
  - Validation and sanitization
  - Duplicate detection
  - Error handling and responses

#### Step 4.2: Workflow Trigger Endpoint
- [ ] Create frontend trigger endpoint:
  - `POST /api/projects/{project_id}/workflows/email/trigger`
  - Generate secure webhook URL
  - Integration with n8n workflow API

#### Step 4.3: API Documentation
- [ ] Update API documentation
- [ ] Create webhook payload examples
- [ ] Add authentication examples

### Phase 5: Advanced Features (Day 3-4)

#### Step 5.1: Full-Text Search
- [ ] Implement PostgreSQL full-text search
- [ ] Add search ranking and highlighting
- [ ] Create search API endpoints

#### Step 5.2: Context Analytics
- [ ] Email volume tracking
- [ ] Category distribution analytics
- [ ] Processing accuracy metrics
- [ ] Dashboard queries

#### Step 5.3: Export & Integration
- [ ] MCP server preparation
- [ ] Export APIs for external tools
- [ ] Context relationship mapping

### Phase 6: RBAC Integration (Day 4)

#### Step 6.1: Permissions Setup
- [ ] Add context management permissions:
  - `context.read` - View contexts
  - `context.write` - Create/edit contexts  
  - `context.admin` - Manage categories
  - `context.ingest` - API ingestion rights

#### Step 6.2: GraphQL Guards
- [ ] Add permission checks to all resolvers
- [ ] Project-level context access control
- [ ] Category-level permissions

#### Step 6.3: API Security
- [ ] Secure webhook endpoints
- [ ] Rate limiting for ingestion
- [ ] Audit logging for context operations

## 🔧 Technical Specifications

### Webhook Payload Format (n8n → FreshAPI)
```json
{
  "email": {
    "messageId": "unique-message-id",
    "from": {
      "email": "sender@company.com",
      "name": "John Doe"
    },
    "to": [
      {"email": "recipient@company.com", "name": "Jane Smith"}
    ],
    "cc": [],
    "subject": "Invoice #INV-2024-001",
    "messageDate": "2024-01-15T10:30:00Z",
    "content": {
      "text": "Full email text content...",
      "html": "<html>Email HTML content...</html>",
      "preview": "Please find attached invoice..."
    }
  },
  "processing": {
    "accountingProcess": "AP",
    "categoryName": "Invoices",
    "aiSummary": "Invoice #INV-2024-001 from ACME Corp for $1,245.50 due Jan 30, 2024",
    "confidenceScore": 0.95,
    "extractedEntities": {
      "invoiceNumber": "INV-2024-001",
      "amount": "$1,245.50",
      "dueDate": "2024-01-30",
      "vendor": "ACME Corp"
    }
  },
  "metadata": {
    "workflowId": "n8n-workflow-123",
    "processedAt": "2024-01-15T10:35:00Z",
    "source": "gmail",
    "attachmentCount": 1
  }
}
```

### GraphQL Query Examples
```graphql
# Get email contexts for a project
query ProjectEmailContexts($projectId: ID!, $filters: EmailContextFilters) {
  project(id: $projectId) {
    emailContexts(filters: $filters) {
      edges {
        node {
          id
          title
          subject
          fromEmail
          accountingProcess
          aiSummary
          confidenceScore
          messageDate
          category {
            name
            color
          }
          tags
        }
      }
      pageInfo {
        hasNextPage
        hasPreviousPage
      }
    }
  }
}

# Search email contexts
query SearchEmailContexts($projectId: ID!, $query: String!) {
  searchEmailContexts(projectId: $projectId, query: $query) {
    id
    subject
    fromEmail
    aiSummary
    searchRank
    highlightedContent
  }
}

# Create email category
mutation CreateEmailCategory($input: CreateContextCategoryInput!) {
  createContextCategory(input: $input) {
    id
    name
    color
    contextType {
      name
    }
  }
}
```

## 🎯 Success Criteria

### Performance Targets
- [ ] Email ingestion: < 500ms per email
- [ ] Search queries: < 200ms for 10K+ emails  
- [ ] Category queries: < 100ms
- [ ] Full-text search: < 1s for complex queries

### Functionality Checklist
- [ ] n8n workflow integration working
- [ ] Email data properly structured and indexed
- [ ] Category management functional in UI
- [ ] Full-text search operational
- [ ] RBAC permissions enforced
- [ ] MCP integration ready

### Quality Gates
- [ ] All database migrations tested (up/down)
- [ ] GraphQL schema validates
- [ ] Webhook endpoints secured
- [ ] Error handling comprehensive
- [ ] Unit tests for core services
- [ ] Integration tests for workflows

## 🔮 Future Extensions

### Phase 7: Additional Context Types
- Document contexts (PDFs, invoices, contracts)
- Meeting contexts (transcripts, action items)
- Transaction contexts (bank records, receipts)

### Phase 8: AI Integration
- MCP server for intelligent context search
- Context relationship detection
- Automated categorization
- Anomaly detection

### Phase 9: Advanced Analytics
- Context trend analysis
- Process efficiency metrics
- Predictive insights
- Custom reporting

## 📝 Development Notes

### Environment Variables
Add to `.env.example`:
```env
# ProjectMind Configuration
PROJECTMIND_ENABLED=true
PROJECTMIND_DEFAULT_CONFIDENCE_THRESHOLD=0.7
PROJECTMIND_MAX_EMAIL_SIZE=10485760  # 10MB
PROJECTMIND_WEBHOOK_SECRET=your-webhook-secret

# n8n Integration
N8N_WEBHOOK_BASE_URL=https://your-n8n-instance.com/webhook
N8N_API_KEY=your-n8n-api-key
```

### Testing Strategy
1. Unit tests for all services
2. Integration tests for webhook endpoints
3. GraphQL resolver tests
4. Database migration tests
5. Performance benchmarks

This comprehensive plan ensures a robust, scalable, and maintainable implementation of the ProjectMind system.